name: "i18n QA Release Gate"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  qa-i18n:
    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5" # v4.2.2

      - name: "Setup Node.js"
        uses: "actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020" # v4.2.0
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install Dependencies"
        run: "npm ci"

      - name: "Install Playwright Browsers"
        run: "npx playwright install --with-deps chromium"

      - name: "Build Application"
        run: "npm run build"
        env:
          APP_ENV: "local"
          NEXT_PUBLIC_SITE_URL: "http://localhost:3000"
          AUTH_SECRET: "${{ secrets.AUTH_SECRET || 'dummy_secret_for_ci' }}"

      - name: "Step 1: Build Route Inventory"
        run: "npm run qa:inventory"

      - name: "Step 2: Verify i18n Coverage (Gating)"
        run: "npm run qa:i18n"

      - name: "Step 3: Run Playwright E2E Crawl"
        run: "npm run qa:test"
        env:
          CI: "true"
          APP_ENV: "local"
          AUTH_TRUST_HOST: "true"
          AUTH_SECRET: "${{ secrets.AUTH_SECRET || 'dummy_secret_for_ci_testing_only_32_chars' }}"
          NEXT_PUBLIC_SITE_URL: "${{ vars.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000' }}"

      - name: "Upload QA Artifacts"
        if: "always()"
        uses: "actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02" # v4
        with:
          name: "i18n-qa-reports"
          path: |
            qa-i18n/i18n-report.md
            qa-i18n/failures/
            playwright-report/
          retention-days: 7
