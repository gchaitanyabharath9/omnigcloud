name: "i18n QA Release Gate"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build:
    name: "üèóÔ∏è Build & Prepare"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"

      - name: "Setup Node.js"
        uses: "actions/setup-node@v4"
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install Dependencies"
        run: "npm ci --legacy-peer-deps"

      - name: "Step 1: Build Application"
        run: "npm run build"
        env:
          APP_ENV: "local"
          NEXT_PUBLIC_SITE_URL: "http://localhost:3000"
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'dummy_secret_for_ci' }}

      - name: "Step 2: Generate Inventory & URLs"
        run: |
          npm run qa:inventory
          npx tsx qa-i18n/scripts/generate-urls.ts

      - name: "Step 3: Verify i18n Coverage (Strict Gate)"
        run: "npm run qa:i18n"

      - name: "Step 4: Upload Build Artifacts"
        uses: "actions/upload-artifact@v4"
        with:
          name: "build-output"
          path: |
            .next/
            public/
            messages/
            qa-i18n/
            package.json
            package-lock.json
            next.config.ts
            .npmrc
            tsconfig.json
          retention-days: 1

  test:
    name: "üß™ Playwright Shard ${{ matrix.shard }}/${{ strategy.job-total }}"
    needs: build
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"

      - name: "Setup Node.js"
        uses: "actions/setup-node@v4"
        with:
          node-version: "20"
          cache: "npm"

      - name: "Download Build Artifacts"
        uses: "actions/download-artifact@v4"
        with:
          name: "build-output"
          path: .

      - name: "Debug: Show Artifacts"
        run: ls -laR .next | head -n 20

      - name: "Install Dependencies"
        run: "npm ci --legacy-peer-deps"

      - name: "Install Playwright Browser (Chromium Only)"
        run: "npx playwright install --with-deps chromium"

      - name: "Run Sharded Tests"
        run: "npx playwright test -c qa-i18n/playwright.config.ts --shard=${{ matrix.shard }}/${{ strategy.job-total }}"
        env:
          CI: "true"
          APP_ENV: "production"
          AUTH_TRUST_HOST: "true"
          AUTH_SECRET: "dummy_secret_for_ci_testing_only_32_chars"
          NEXT_PUBLIC_SITE_URL: "http://localhost:3000"

      - name: "Upload Shard Results"
        if: "always()"
        uses: "actions/upload-artifact@v4"
        with:
          name: "playwright-report-${{ matrix.shard }}"
          path: "playwright-report/"
          retention-days: 7
